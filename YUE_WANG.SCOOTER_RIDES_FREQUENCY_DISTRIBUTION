--riding distribution by riding frequency--

CREATE OR REPLACE TABLE
YUE_WANG.SCOOTER_RIDES_FREQUENCY_DISTRIBUTION AS (
 WITH 
 USER_RIDE_FREQ AS(
 SELECT
 RIDER_ID
,COUNT (*) AS RIDE_FREQ
FROM APPLICANTS.YUE_WANG.RIDE_CORE
GROUP BY 1
 )
 ,
RERIDE_HISTOGRAM AS (
 SELECT RIDE_FREQ
 ,COUNT(RIDER_ID) NUM_OF_RIDERS
  FROM  USER_RIDE_FREQ
 GROUP BY 1
 ORDER BY 1)
  ,
 FINAL_TABLE AS(
   SELECT
   RIDE_FREQ
  ,NUM_OF_RIDERS
  ,SUM(NUM_OF_RIDERS) OVER(ORDER BY RIDE_FREQ) CUM_NUM_RIDERS
  ,ROUND(SUM(NUM_OF_RIDERS)OVER (ORDER BY RIDE_FREQ)
         /(SELECT SUM (NUM_OF_RIDERS) FROM RERIDE_HISTOGRAM)::NUMERIC * 100,2) ||'%' CUM_PCT_RIDERS
  FROM RERIDE_HISTOGRAM
  )
  SELECT * FROM FINAL_TABLE
 );
 
